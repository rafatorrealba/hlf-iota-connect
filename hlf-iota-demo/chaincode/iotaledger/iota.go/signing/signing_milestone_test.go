package signing_test

import (
	"github.com/iotaledger/iota.go/consts"
	. "github.com/iotaledger/iota.go/curl"
	"github.com/iotaledger/iota.go/merkle"
	. "github.com/iotaledger/iota.go/signing"
	. "github.com/iotaledger/iota.go/transaction"
	. "github.com/iotaledger/iota.go/trinary"
	. "github.com/onsi/ginkgo"
	. "github.com/onsi/gomega"
)

var _ = Describe("Signing", func() {
	const cooAddress = "KPWCHICGJZXKE9GSUDXZYUAPLHAKAHYHDXNPHENTERYMMBQOPSQIDENXKLKCEYCPVTZQLEEJVYJZV9BWU"

	const NUMBER_OF_KEYS_IN_MILESTONE uint64 = 20
	const milestoneIndex uint64 = 881506
	const trytesMsTx1 = "TRZLNPUJJWZLQ9O9ORWPFEEROJVUEGJCQ99FAHQE99PFRIAWVUETRMWNNWFWJBVFOHRIXRZUEUOPXYFZCBJAUXAVHNFAYAK9UMFLIODHGSGFUGPGHQMSNFKLIWTEHHWLT9GLYHWWNRZUQNTVYFKKGBCTICTCVEJDUVJZYHBYQGVMHOUJXNVQIFLEDXXZSILGCZRQAMIXFSBFBZBFIHCOAUZCETRULDMSRKMSCG9LRIFVVNQHAOQCSWA9BOKN9XVXUOOYPCGAHFWZQEHTOXTUZPUUWOAH9CIVGNBGISCQPWRKMZZSCIQAIAVXIYTMWRPTLCQZGRAAHUJYNCPBQJK9VLOESU99FMWETKUCIBTZPCAVZJQXOOAFVICJZFGKLCSXTAOUOHIZTJBMUHSSTNCWQKKQ9WUBELSNYXOMHKPNVUYZOGFFWHVSORIGYQYDPKDY9HHVWYT9CZZXAHCPYQNMREEAIXDTKRJQXTOPY9FZUTVNPKVMFHSOIGWRZO9JDGKDJWLD9BNZIPCBYSDQURHOHCZT9UJGRETWQUOXAZQQQJCHID9AJJBSZISKNFLJQECBQNJGTOGCFCVRGSYCYBREJXFETKIHQOMGGHVFXAXYBNPHXJATKSABYMQERL99TNEPLSOIQWPPPFDRXRGEXAPZRDYZBXJTLTGTTICSPUEFOFRFJENJCDYZQVGMEMMWNDJWICN99BKFRX99ZZTKHDAODNTYAHJAQAOYASXDX9RSJHDXYFMMJSVZIBNWWEEXYRPSPRHWSBAENRYLXC9BDQCMGIESRNCPGBLTVZTY9EYVXRIKBEQY9JSSTBGCSKRNTLLJY9R9UDNWMHVCYKJCVEJAEBYMRODQWDCZQ9IOEPEVOGNOCNUWDCUEWNFUSLGYMJSC9ZUPXCGYT9ZIASDJLQJLYRIGFDZZFYCUAJTTYLQJVJWYECPVWEYGWKWIHRYZDFICROGUBAORLBQHCL9DIBQRV9NSYXWSAHJKMSXIFPOLVJAPPYV9SGLSPIAHQWXRRFXG9DMEMRWGHOVGLSCSBRZTZVIKMTERQCS9GVFJGTCVEIVLBWWGBO9XKOJMDPMUXMYYK9R9BSHLGRBOMWUAWDXEQEAWBJKXVLBTL9OBYOWFHSIXOPTQVFVIGFFJFXJHTJUQRGIXKBEXORMGCXMLPOCYFJWKU9SDBBGKOBGAPSWGLZFOGXSPQRLUGRDUDIYOHEXLGYSWZRPYDIUYZJ9IELS9USHGIROHBHHIFX9AMKTZXOGH9BRKSKOYTHVWLV9JZM9QPKJZZWVKOCEZ9PDMPFUZGPBLTAQKKWJVFBXGQWGBKZMIHLYBKO9KGCLXVNPWIKPIZRFPPEYZBLRWDTHVRRNLLDB9NOAAGEHTSNZRBYTQDRMIIVTQPFUCGUGTT9HMHHANWHOQ9QEYP9TJQQAPPRIUOBNTKPX9V9EFDLVEXBCFCJHJORVEMUSIZIZLKCXFRWVW9AFCYJCSIHZIVVZUNWDOGCCUMS9NMVEQJKTSTXDOMXUFKRBKCTIAZGMRUVKUG9ACEHGZ9NODFHVCORHETF9RHUTRAZYDQWXJIFTAAAGYKRBEUIUGSVINCUOMVLZS9JKXRIXSAMOD9NC9IRGKXTGKMKECQYOZKBRWYALEWTFFGQU9OANXNSDRGSGLJNURYQPEDGXATPPSLSTGTQTBQOKQGJOTCMPTD9UMWCHPLDOEFZFMIQJLDTWHAZJYBOFBAFKWMIOHSEMWOKENWJTICLUDWPQMPHLQURZVYNGYADPLIJP9UWLTEWA9BIORPPEFRQMAZCVHBWXJCOLODUGKUIUNUWSHUDDFLERKCRDMUYCUASWOGXCXRQPUJTXGDS9OBVFRFYXFKNRMAUPCZKD9DGVXAPBO99ZWCTGWNQKMGXXFVXHGDNTOAMEWWKCDNWDGKKVQ9JPPZZXBTEFLBAFKHIM9VOFDLJOHRIWISTWQCMIAIZD9WJUDACSOZYMUPWMLRSRDRBMKKJAZ9LWJREVOPLRGSLMITHLGUQBBKY9XPWQZGIKDKOEYSOQQGCUAYWRBTRANTAMESRYK9ZAMAXDGIKSRCBSZDCLWCSSHAJSIWPXRGPBIVXGNZWBWPZWPWX9MHDLPWYNCCPEPVRDUXHDUNDWWWDATITVQFMRGRWJQAKKTYDMPYGAKYHHOTKLVZKVHDWIIPPHCVB9TGEQKPWCHICGJZXKE9GSUDXZYUAPLHAKAHYHDXNPHENTERYMMBQOPSQIDENXKLKCEYCPVTZQLEEJVYJZV9BWU999999999999999999999999999JEURB9999999999999999999999EJVBMZD99999999999A99999999FCCIAAKYIYCDFNJZJDCPKND9ONMKHVC9UIXGRIILSWUODUKPSEBS9RREJGYAFLGQRYWYFR9UIMHVEUKJAMUPBNTNJTQNBGLLKJWKVJHEDDWBDHBUFKXEQALOZX9PTXAPPGNYAFJPPFDOM9AFBCWUSQTUSKGRLZ9999RRXBJQIBWGPCW9SFWVZTBJGJEOKRILWSLBBVNMZJHQEJIHKRGMMIZHTJBLMHKGS9SKNQCVBCVTOUZ9999999999999999999999999999999999999999999999999999999999ZHWTS9ITKCARXAAITBPHYPXQOM9"
	const trytesMsTx2 = "SLO9VVX9SEIUNUQSOJKRSBHHXAEGJUNVZGWTHIQQNYQO9MCCJZDOVTGYBLEFYVREZGTWVVROULNMTFYILMNCDLKBQZVFNXDNYUXDTKS9YIUUH9URAZBQ9AGAJ9PXXUYAIMPZMYKRGUWJFPWISLYOFAH9PYYZAZOYIRFMMEIXWVFACOWSRDZLTRRPXLUHNBDCQEYNWVVNOUJTJPVOMFVGPO9TRJ9PHVQWXMKLMSUPK9TITDWHMVRDHCERIV9QPJTTFUJXPURR9KF9HMNCIYQJLJPVJ99VVIBNMNZYIUWWWTGPGDNPXMBWNBJQRFNNFDKTYDUABVHVIHHBZAVKMMBNPOVJQGSKVHNTKWONIGLZKDPSB99YTDUJCUGUNLTQYPWSIXY9JYACDZMFLTGKZILVTEODUUTMVLRSFSOIREJSDAWEFKDVASBZLJKEOVCGEFCZSBLGRYOSCGGKFCDFNXEEJJKBAPEAYNEXTDUSSMCQZJUTUOVLBLCCSRCR99NRUQCKYWQGFJXMKASRAYX9SDJXALDZ9TIZB9DADCK9TX9SFXMQCIHDCGJSCIHWAC9XTZULORQJ9XVHMEFNLUHMKFCKDHWVEOSJGKPTSACPUWAVLPBEVCXVDHYVBYQWHOZCMRFXCRG9PDJN9FIUMCTP9JNIJUSGQVYNWDVQRSKVRTAPDAXTYBABSIBISYWFUOLMZQXNDEHTJBCYWBJ9QTAFWBT9GOEIVXNGTHDB9WOWKEGX9MCLZV9DFLCELSRLZKQXNMCVTWRJZTAOERTTEHTDOOZVSVHEBBSJDWMBLWSVMUAGSJXHNGJFLC9UEDGAYEZLVAHIALWRSXNKORWPXUAXCYGVBSZVYKTTPATJRFBNTWW9IEKVONATJOCAERWFNCGWNHXAL9ASMIFCYFFXCPRFLQCGQVNUGBMEXIQTFMGCMPAOKRZEYMYWFDRRVELYNDLPFGZDWGGQDNZIBLYNGOEKWMLRTFGNWHVMRAQVWTAMFXHUGMASKPLPBKESNCRBEGLLVJDQLIQXRNRYCOHRVVTDEEO9ESIIINKOTHQ99GMRCHXAOCAOQLMSUPEBNEJANPCEUXTWHOEKQRSTZTYZBLAHSBOGPMPGQEZZPUKLBSMKFRGKCWYGLRQDITOBWQOHRQFZJHZEPXD9EOXRWSR9YRLKLAAJGHHIRCPXYIP9BJ9WU9DYSFQMVEDTSGAONNPCKECNDVQELBPZXVJOPJARGPPZWZ9XPSPFFJSII9PUYOTL9BLGZGXUP9SRGXZCMXOZV9MZLPZRSDHANXEMHDHMZVLXDLYSPUFZSIGRWEDN9LOOIXGHJDZWJQCPNQCDLMV9DP9HGYRBJODHICIUNOMXXFVLUUYZRMSMOMATVHOSZCPBJNDWYDQNUKJSZDEPHKGPCWINQJAMRWTMLDBADVGJFGBAAEHTORSR9HCTWEDBULTRJ9QKJTLSNXXU9FRCINCAATXRPSKRTGOWPMPWMKNGQETVXNDKJFCKIEQB9CBPEHCLATHLOQMHPGUNKMHMDMVTVLNYJCNGEAJRBXSFUUKOAHKAPHTIIDMYEAZYGKFVJBSDJPVVOQLRWCQEDECG99RARUYJYXIMAEVFRWJ9SJFUSNN9KZGR999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999EJVBMZD99A99999999A99999999FCCIAAKYIYCDFNJZJDCPKND9ONMKHVC9UIXGRIILSWUODUKPSEBS9RREJGYAFLGQRYWYFR9UIMHVEUKJARRXBJQIBWGPCW9SFWVZTBJGJEOKRILWSLBBVNMZJHQEJIHKRGMMIZHTJBLMHKGS9SKNQCVBCVTOUZ9999RRXBJQIBWGPCW9SFWVZTBJGJEOKRILWSLBBVNMZJHQEJIHKRGMMIZHTJBLMHKGS9SKNQCVBCVTOUZ9999999999999999999999999999999999999999999999999999999999ATTPAVULAKMRCMHUYODBIJZLCDO"

	Context("MerkleRoot()", func() {
		It("Checks milestone signature", func() {
			mxTx1, err := AsTransactionObject(trytesMsTx1)
			Expect(err).ToNot(HaveOccurred())

			mxTx1SignatureMessageFragmentTrits := MustTrytesToTrits(mxTx1.SignatureMessageFragment)[:consts.SignatureMessageFragmentTrinarySize]
			mxTx2Trits := MustTrytesToTrits(trytesMsTx2)[:consts.TransactionTrinarySize]

			c := NewCurlP27()

			normalized := NormalizedBundleHash(mxTx1.TrunkTransaction)[:27]
			digests, err := Digest(normalized, mxTx1SignatureMessageFragmentTrits, c)
			Expect(err).ToNot(HaveOccurred())
			address, err := Address(digests, c)
			Expect(err).ToNot(HaveOccurred())

			merkleRoot, err := merkle.MerkleRoot(
				address,
				mxTx2Trits,
				NUMBER_OF_KEYS_IN_MILESTONE,
				milestoneIndex,
				c,
			)
			Expect(err).ToNot(HaveOccurred())

			merkleAddress := MustTritsToTrytes(merkleRoot)
			Expect(merkleAddress).To(Equal(cooAddress))
		})
	})
})
